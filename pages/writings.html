<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writings - My Freeform</title>
  <link rel="icon" href="../icon.png" sizes="512x512">
  <link rel="apple-touch-icon" href="../icon.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <header>
    <h1>Writings</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="ideas.html">Ideas</a>
      <a href="writings.html" class="active">Writings</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <p>A growing collection of longer writings and essays.</p>
    </section>
	
		<!-- üîÑ Real Toggle Switch -->
<div class="public-mode-toggle">
  <label class="switch">
    <input type="checkbox" id="publicModeToggle">
    <span class="slider"></span>
  </label>
  <span id="publicModeLabel">Public Mode: OFF</span>
</div>

    <section class="content-blocks">
      <div class="block">
        <h3>Submit New Writing</h3>
        <input type="text" id="writingTitle" placeholder="Title" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
        <textarea id="writingContent" placeholder="Your full writing here..." rows="6"></textarea>
        <button id="addWritingBtn">Post Writing</button>

        <div id="writingList"></div>

        <a href="writing-history.html" class="view-history-link">View All Writings ‚Üí</a>
      </div>
    </section>
  </main>

  <section class="storage-meter">
    <p id="storageInfo">Calculating storage...</p>
  </section>

  <footer>
  
  <div class="disclaimer-popover">
  <span class="disclaimer-label">Disclaimer</span>
  <div class="disclaimer-box">
    <p><strong>Local Storage Only:</strong> All your writings are saved in your browser. Nothing is uploaded or shared.</p>
    <ul>
      <li><strong>Private</strong> ‚Äì Your entries never leave your device.</li>
      <li><strong>Offline-friendly</strong> ‚Äì Works without internet once loaded.</li>
      <li><strong>5MB Limit</strong> ‚Äì Uses local storage (~5MB available).</li>
      <li><strong>No Backup</strong> ‚Äì Clearing browser data erases all entries.</li>
    </ul>
  </div>
</div>
  
    <p>&copy; 2025 My Freeform. All rights reserved.</p>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBD-8hcoAuTFaAhgSy-WIyQX_iI37uokTw",
    authDomain: "myfreeformarchive-8a786.firebaseapp.com",
    projectId: "myfreeformarchive-8a786",
    storageBucket: "myfreeformarchive-8a786.appspot.com",
    messagingSenderId: "16237442482",
    appId: "1:16237442482:web:424f8f2e344a58e7f6a0ab"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.addEventListener("DOMContentLoaded", () => {
    const writingTitle = document.getElementById("writingTitle");
    const writingContent = document.getElementById("writingContent");
    const addWritingBtn = document.getElementById("addWritingBtn");
    const writingList = document.getElementById("writingList");
    const toggle = document.getElementById("publicModeToggle");

    let writings = JSON.parse(localStorage.getItem("writings")) || [];

    const renderWritings = () => {
      writingList.innerHTML = "";
      const latestFive = writings.slice(-5).reverse();

      latestFive.forEach(writing => {
        const box = document.createElement("div");
        box.className = "entry-box";

        const titleEl = document.createElement("p");
        titleEl.className = "entry-text writing-title";
        titleEl.textContent = writing.title;

        const dateEl = document.createElement("p");
        dateEl.className = "entry-text writing-date";
        dateEl.textContent = `Date: ${writing.date}`;

        const contentEl = document.createElement("p");
        contentEl.className = "entry-text writing-content";
        contentEl.textContent = `${writing.content.substring(0, 200)}...`;

        box.appendChild(titleEl);
        box.appendChild(dateEl);
        box.appendChild(contentEl);
        writingList.appendChild(box);
      });
    };

    addWritingBtn.addEventListener("click", async () => {
      const title = writingTitle.value.trim();
      const content = writingContent.value.trim();
      if (!title || !content) return;

      const writing = {
        title,
        content,
        date: new Date().toLocaleDateString()
      };

      writings.push(writing);

      try {
        localStorage.setItem("writings", JSON.stringify(writings));

        if (toggle && toggle.checked) {
          try {
            const docRef = await addDoc(collection(db, "publicWritings"), {
              title,
              content,
              createdAt: serverTimestamp()
            });

            writing.firebaseId = docRef.id;
            localStorage.setItem("writings", JSON.stringify(writings));
            console.log("‚úÖ Writing saved to Firestore:", docRef.id);
          } catch (err) {
            console.error("‚ùå Firebase error (writing):", err);
          }
        }
      } catch (e) {
        alert("‚ö†Ô∏è Storage full! Cannot save new writing.");
        console.error("Storage limit reached for writings:", e);
        writings.pop();
        return;
      }

      writingTitle.value = "";
      writingContent.value = "";
      renderWritings();
      updateStorageInfo();
    });

    // STORAGE METER
    function getStorageSize(key) {
      const item = localStorage.getItem(key);
      return item ? new Blob([item]).size : 0;
    }

    function updateStorageInfo() {
      const beliefsSize = getStorageSize("beliefs");
      const progressSize = getStorageSize("inProgress");
      const ideasSize = getStorageSize("ideas");
      const writingsSize = getStorageSize("writings");
      const totalUsed = beliefsSize + progressSize + ideasSize + writingsSize;

      const maxStorage = 5 * 1024 * 1024;
      const usedKB = (totalUsed / 1024).toFixed(1);
      const freeKB = ((maxStorage - totalUsed) / 1024).toFixed(1);
      const percentUsed = ((totalUsed / maxStorage) * 100).toFixed(2);

      const infoEl = document.getElementById("storageInfo");
      if (infoEl) {
        infoEl.innerHTML = `
          <strong>Storage Used:</strong> ${usedKB} KB 
          &nbsp;|&nbsp; 
          <strong>Free:</strong> ${freeKB} KB 
          &nbsp;|&nbsp; 
          <strong>${percentUsed}% of 5MB</strong>
        `;
      }
    }

    renderWritings();
    updateStorageInfo();
  });
</script>

</body>
</html>
