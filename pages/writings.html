<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writings - My Freeform</title>
  <link rel="icon" href="../icon.png" sizes="512x512">
  <link rel="apple-touch-icon" href="../icon.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <header>
    <h1>Writings</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="ideas.html">Ideas</a>
      <a href="writings.html" class="active">Writings</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <p>A growing collection of longer writings and essays.</p>
    </section>
	
		<!-- üîÑ Real Toggle Switch -->
<div class="public-mode-toggle">
  <label class="switch">
    <input type="checkbox" id="publicModeToggle">
    <span class="slider"></span>
  </label>
  <span id="publicModeLabel">Public Mode: OFF</span>
</div>

    <section class="content-blocks">
      <div class="block">
        <h3>Submit New Writing</h3>
        <input type="text" id="writingTitle" placeholder="Title" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
        <textarea id="writingContent" placeholder="Your full writing here..." rows="6"></textarea>
        <button id="addWritingBtn">Post Writing</button>

        <div id="writingList"></div>

        <a href="writing-history.html" class="view-history-link">View All Writings ‚Üí</a>
      </div>
    </section>
  </main>

  <section class="storage-meter">
    <p id="storageInfo">Calculating storage...</p>
  </section>

  <footer>
  
  <div class="disclaimer-popover">
  <span class="disclaimer-label">Disclaimer</span>
  <div class="disclaimer-box">
    <p><strong>Local by Default:</strong> All entries are saved in your browser unless you choose to share them.</p>
    <ul>
      <li><strong>Private by Default</strong> ‚Äì Your entries stay on your device unless Public Mode is enabled.</li>
      <li><strong>Optional Sharing</strong> ‚Äì Enable Public Mode to upload selected entries to a public archive.</li>
      <li><strong>Offline-Friendly</strong> ‚Äì Works without internet once loaded.</li>
      <li><strong>5MB Limit</strong> ‚Äì Uses browser local storage (~5MB available).</li>
      <li><strong>No Automatic Backup</strong> ‚Äì Clearing browser data will erase your entries unless shared.</li>
    </ul>
  </div>
</div>
  
    <p>&copy; 2025 My Freeform. All rights reserved.</p>
  </footer>

<!-- Firebase SDKs (load first) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBD-8hcoAuTFaAhgSy-WIyQX_iI37uokTw",
    authDomain: "myfreeformarchive-8a786.firebaseapp.com",
    projectId: "myfreeformarchive-8a786",
    storageBucket: "myfreeformarchive-8a786.appspot.com",
    messagingSenderId: "16237442482",
    appId: "1:16237442482:web:424f8f2e344a58e7f6a0ab"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("publicModeToggle");
  const label = document.getElementById("publicModeLabel");
  const PUBLIC_MODE_KEY = "publicModeEnabled";

  // üìå Persist Toggle State
  if (toggle && label) {
    const saved = localStorage.getItem(PUBLIC_MODE_KEY) === "true";
    toggle.checked = saved;
    label.textContent = saved ? "Public Mode: ON" : "Public Mode: OFF";

    toggle.addEventListener("change", () => {
      const on = toggle.checked;
      localStorage.setItem(PUBLIC_MODE_KEY, on);
      label.textContent = on ? "Public Mode: ON" : "Public Mode: OFF";
    });
  }

  const writingTitle = document.getElementById("writingTitle");
  const writingContent = document.getElementById("writingContent");
  const addWritingBtn = document.getElementById("addWritingBtn");
  const writingList = document.getElementById("writingList");

  let writings = JSON.parse(localStorage.getItem("writings")) || [];

  const renderWritings = () => {
    writingList.innerHTML = "";
    const latestFive = writings.slice(-5).reverse();

    latestFive.forEach(entry => {
      const titleText = typeof entry === "string" ? entry : entry.title;
      const contentText = entry.content ?? "";

      const box = document.createElement("div");
      box.className = "entry-box";

      const titleEl = document.createElement("p");
      titleEl.className = "entry-text writing-title";
      titleEl.textContent = titleText;

      const dateEl = document.createElement("p");
      dateEl.className = "entry-text writing-date";
      dateEl.textContent = `Date: ${entry.date ?? ""}`;

      const contentEl = document.createElement("p");
      contentEl.className = "entry-text writing-content";
      contentEl.textContent = contentText.length > 200
        ? contentText.substring(0, 200) + "..."
        : contentText;

      box.appendChild(titleEl);
      box.appendChild(dateEl);
      box.appendChild(contentEl);

      writingList.appendChild(box);
    });
  };

  addWritingBtn.addEventListener("click", async () => {
    const title = writingTitle.value.trim();
    const content = writingContent.value.trim();
    if (!title || !content) return;

    const entry = {
      title,
      content,
      date: new Date().toLocaleDateString(),
      firebaseId: null
    };

    const publicMode = localStorage.getItem(PUBLIC_MODE_KEY) === "true";

    try {
      // üî• Save to Firestore if public mode ON
      if (publicMode && typeof db !== "undefined") {
        try {
          const docRef = await db.collection("publicWritings").add({
            title,
            content,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          entry.firebaseId = docRef.id;
          console.log("‚úÖ Writing saved to Firestore:", docRef.id);
        } catch (firebaseErr) {
          console.error("‚ùå Firebase error (writing):", firebaseErr);
        }
      }

      // üíæ Always save locally
      writings.push(entry);
      localStorage.setItem("writings", JSON.stringify(writings));

    } catch (e) {
      alert("‚ö†Ô∏è Storage full! Cannot save new writing.");
      console.error("Local Storage error:", e);
      return;
    }

    writingTitle.value = "";
    writingContent.value = "";
    renderWritings();
    updateStorageInfo();
  });

  renderWritings();

  // ========================
  // üíæ STORAGE USAGE METER
  // ========================
  function getStorageSize(key) {
    const item = localStorage.getItem(key);
    return item ? new Blob([item]).size : 0;
  }

  function updateStorageInfo() {
    const beliefsSize = getStorageSize("beliefs");
    const progressSize = getStorageSize("inProgress");
    const ideasSize = getStorageSize("ideas");
    const writingsSize = getStorageSize("writings");
    const totalUsed = beliefsSize + progressSize + ideasSize + writingsSize;

    const maxStorage = 5 * 1024 * 1024;
    const usedKB = (totalUsed / 1024).toFixed(1);
    const freeKB = ((maxStorage - totalUsed) / 1024).toFixed(1);
    const percentUsed = ((totalUsed / maxStorage) * 100).toFixed(2);

    const infoEl = document.getElementById("storageInfo");
    if (infoEl) {
      infoEl.innerHTML = `
        <strong>Storage Used:</strong> ${usedKB} KB 
        &nbsp;|&nbsp; 
        <strong>Free:</strong> ${freeKB} KB 
        &nbsp;|&nbsp; 
        <strong>${percentUsed}% of 5MB</strong>
      `;
    }
  }

  updateStorageInfo();
});
</script>


</body>
</html>

