<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discover â€” My Freeform</title>
  <link rel="icon" href="../icon.png" sizes="512x512" />
  <link rel="apple-touch-icon" href="../icon.png" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="stylesheet" href="../style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
.pagination {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

.pagination button {
  padding: 4px 8px;
  border: 1px solid #ccc;
  background-color: white;
  cursor: pointer;
  color: black;
}

.pagination button.active {
  background-color: #333;
  color: white;
  border-color: #333;
}  
  
.block {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
#writingsBlock {
}
/* â€”â€” ENTRY MODAL â€”â€” */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  display: flex;
  justify-content: center;
  align-items: start;
  padding: 40px;
  z-index: 9999;
  overflow-y: auto;
}

.modal.hidden {
  display: none;
}

.modal-content {
  background: #fff;
  width: 90%;
  max-width: 800px;
  padding: 60px 25px 35px; 
  border-radius: 8px;
  position: relative;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  max-height: 90vh;
  overflow-y: auto;
}

#modalEntry {
  font-size: 17px;
  line-height: 1.6;
  color: #222;
  margin-bottom: 30px;
}

#modalEntry h2 {
  font-size: 24px;
  margin-bottom: 10px;
  font-weight: 600;
}

.modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  border: none;
  background-color: #3F51B5;
  color: #fff;
  font-size: 20px;
  font-weight: bold;
  padding: 6px 10px;
  border-radius: 4px;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
  cursor: pointer;
  z-index: 10;
  transition: background-color 0.2s, color 0.2s;
}

.modal-close:hover {
  background-color: #2c3a99;
}

.entry-box {
  cursor: pointer;
  transition: transform 0.15s ease, background-color 0.15s ease;
  padding: 12px;
  border-radius: 6px;
}

.entry-box:hover {
  transform: scale(1.02);
  background: #fafafa;
}

/* Comments Section */
.comments-section {
  margin-top: 20px;
  font-size: 14px;
  color: #555;
}

.comments-section h4 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 10px;
  color: #3F51B5;
}

#commentsList {
  max-height: 200px;
  overflow-y: auto;
  border-top: 1px solid #ddd;
  padding-top: 10px;
  margin-bottom: 15px;
}

#commentsList .comment {
  background: #f6f6f6;
  border-left: 4px solid #3F51B5;
  padding: 6px 10px;
  margin-bottom: 8px;
  border-radius: 4px;
  font-size: 13px;
  color: #333;
}

#newComment {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
  resize: none;
  margin-bottom: 10px;
}

#submitComment {
  background-color: #3F51B5;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s;
}

#submitComment:hover {
  background-color: #2c3a99;
}
</style>
</head>
<body>
  <header>
    <h1>Discover</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="ideas.html">Ideas</a>
      <a href="writings.html">Writings</a>
      <a href="discover.html" class="active">Discover</a>
    </nav>
  </header>

  <main>
    <section class="content-blocks">

      <!-- CORE BELIEFS -->
      <div class="block">
        <h3>Latest Public Core Beliefs</h3>
        <div id="discoverBeliefs">Loading...</div>
        <div class="pagination" id="paginationBeliefs"></div>
      </div>

      <!-- INâ€‘PROGRESS THOUGHTS -->
      <div class="block">
        <h3>Latest Public Inâ€‘Progress Thoughts</h3>
        <div id="discoverInProgress">Loading...</div>
        <div class="pagination" id="paginationInProgress"></div>
      </div>

      <!-- IDEAS -->
      <div class="block">
        <h3>Latest Public Ideas</h3>
        <div id="discoverIdeas">Loading...</div>
        <div class="pagination" id="paginationIdeas"></div>
      </div>

      <!-- WRITINGS -->
      <div class="block" id="writingsBlock">
        <h3>Latest Public Writings</h3>
        <div id="discoverWritings">Loading...</div>
        <div class="pagination" id="paginationWritings"></div>
      </div>

    </section>
  </main>

  <footer>
    <div class="disclaimer-popover">
      <span class="disclaimer-label">Disclaimer</span>
      <div class="disclaimer-box">
        <p><strong>Local by Default:</strong> All entries are saved in your browser unless you choose to share them.</p>
        <ul>
          <li><strong>Private by Default</strong> â€“ Your entries stay on your device unless Public Mode is enabled.</li>
          <li><strong>Optional Sharing</strong> â€“ Enable Public Mode to upload entries to a public archive.</li>
          <li><strong>5MB Limit</strong> â€“ Uses browser local storage (~5MB available).</li>
          <li><strong>No Automatic Backup</strong> â€“ Clearing browser data will erase your entries unless shared.</li>
        </ul>
      </div>
    </div>
    <p>&copy; 2025â€“<span id="year"></span> My Freeform. All rights reserved.</p>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBD-8hcoAuTFaAhgSy-WIyQX_iI37uokTw",
      authDomain: "myfreeformarchive-8a786.firebaseapp.com",
      projectId: "myfreeformarchive-8a786",
      storageBucket: "myfreeformarchive-8a786.appspot.com",
      messagingSenderId: "16237442482",
      appId: "1:16237442482:web:424f8f2e344a58e7f6a0ab"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const PAGE_SIZE = 3;

      async function fetchPaginatedEntries(collectionName, containerId, pageNum = 1) {
        try {
          const collectionRef = db.collection(collectionName).orderBy("createdAt", "desc");

          const totalSnapshot = await collectionRef.get();
          const total = totalSnapshot.docs.length;
          const totalPages = Math.ceil(total / PAGE_SIZE);
          const start = (pageNum - 1) * PAGE_SIZE;
          const pageDocs = totalSnapshot.docs.slice(start, start + PAGE_SIZE);

          showEntries(containerId, pageDocs);
          showPaginationButtons(containerId, collectionName, totalPages, pageNum);
        } catch (err) {
          console.error("Error fetching", collectionName, err);
          document.getElementById(containerId).innerHTML = "<p>Error loading entries.</p>";
        }
      }

      function showEntries(containerId, entries) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  if (!entries.length) {
    container.innerHTML = "<p>No public entries yet.</p>";
    return;
  }

  entries.forEach(doc => {
    const data = doc.data();
    const box = document.createElement("div");
    box.className = "entry-box";

    // STORE doc ID to open detail view
    box.dataset.docId = doc.id;
    box.dataset.collection = containerId.replace("discover", "public");

    // Display Title
    if (data.title) {
      const titleEl = document.createElement("p");
      titleEl.className = "writing-title";
      titleEl.textContent = data.title;
      box.appendChild(titleEl);
    }

    // Display content snippet
    const contentEl = document.createElement("p");
    contentEl.className = "entry-text";
    contentEl.textContent = data.content ?? data.text ?? "";
    box.appendChild(contentEl);

    // Timestamp
    if (data.createdAt && data.createdAt.toDate) {
      const dateEl = document.createElement("p");
      dateEl.className = "writing-date";
      dateEl.textContent = `Posted: ${data.createdAt.toDate().toLocaleString()}`;
      box.appendChild(dateEl);
    }

    // OPEN DETAIL VIEW ON CLICK
    box.addEventListener("click", () => openEntryDetail(data, doc.id, containerId));

    container.appendChild(box);
  });
}


      function showPaginationButtons(containerId, collectionName, totalPages, currentPage) {
        const paginationId = "pagination" + containerId.replace("discover", "");
        const paginationContainer = document.getElementById(paginationId);
        paginationContainer.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          if (i === currentPage) btn.classList.add("active");
          btn.addEventListener("click", () => {
            fetchPaginatedEntries(collectionName, containerId, i);
          });
          paginationContainer.appendChild(btn);
        }
      }
	  
	  // === MODAL & COMMENTS ===
const modal = document.getElementById("entryModal");
const modalEntry = document.getElementById("modalEntry");
const closeModal = document.getElementById("closeModal");
const commentsList = document.getElementById("commentsList");
const newComment = document.getElementById("newComment");
const submitComment = document.getElementById("submitComment");

closeModal.addEventListener("click", () => modal.classList.add("hidden"));

let currentEntryData = null;
let currentEntryDocId = null;
let currentEntryContainer = null;

async function openEntryDetail(data, docId, containerId) {
  currentEntryData = data;
  currentEntryDocId = docId;
  currentEntryContainer = containerId;

  modal.classList.remove("hidden");
  modalEntry.innerHTML = "";

  const title = data.title ? `<h2>${data.title}</h2>` : "";
  modalEntry.innerHTML = `
    ${title}
    <p>${data.content ?? data.text ?? ""}</p>
  `;

  commentsList.innerHTML = "";

  const commentCollection = `${containerId}_comments`;
  const commentSnapshot = await db
    .collection(commentCollection)
    .doc(docId)
    .collection("comments")
    .orderBy("createdAt", "desc")
    .get();

  commentSnapshot.forEach(doc => {
    const c = doc.data();
    const div = document.createElement("div");
    div.className = "comment";
    div.textContent = c.text;
    commentsList.appendChild(div);
  });

  submitComment.dataset.docId = docId;
  submitComment.dataset.collection = commentCollection;
}

submitComment.addEventListener("click", async () => {
  const text = newComment.value.trim();
  if (!text) return;

  const docId = submitComment.dataset.docId;
  const collection = submitComment.dataset.collection;

  await db
    .collection(collection)
    .doc(docId)
    .collection("comments")
    .add({
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  newComment.value = "";

  // ðŸ’¡ Reopen using stored entry data (no flash/blank)
  openEntryDetail(currentEntryData, currentEntryDocId, currentEntryContainer);
});


      fetchPaginatedEntries("publicBeliefs", "discoverBeliefs");
      fetchPaginatedEntries("publicInProgress", "discoverInProgress");
      fetchPaginatedEntries("publicIdeas", "discoverIdeas");
      fetchPaginatedEntries("publicWritings", "discoverWritings");
    });
  </script>
  
  <!-- ENTRY DETAIL MODAL -->
<div id="entryModal" class="modal hidden">
  <div class="modal-content">
    <button id="closeModal" class="modal-close">âœ•</button>
    <div id="modalEntry"></div>
    <div id="commentsSection" class="comments-section">
      <h4>Comments</h4>
      <div id="commentsList"></div>
      <textarea id="newComment" placeholder="Add a comment..."></textarea>
      <button id="submitComment">Post Comment</button>
    </div>
  </div>
</div>
  
</body>
</html>
