<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writings History</title>
  <link rel="icon" href="../icon.png" sizes="512x512">
  <link rel="apple-touch-icon" href="../icon.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <header>
    <h1>Writing History</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="ideas.html">Ideas</a>
      <a href="writings.html">Writings</a>
    </nav>
  </header>

  <main>
    <section class="content-blocks">
      <div class="block">
        <h3>All Saved Writings</h3>
        <div id="fullWritingList"></div>
      </div>
    </section>
  </main>

  <section class="storage-meter">
    <p id="storageInfo">Calculating storage...</p>
  </section>

  <footer>
  
  <div class="disclaimer-popover">
  <span class="disclaimer-label">Disclaimer</span>
  <div class="disclaimer-box">
    <p><strong>Local by Default:</strong> All entries are saved in your browser unless you choose to share them.</p>
    <ul>
      <li><strong>Private by Default</strong> ‚Äì Your entries stay on your device unless Public Mode is enabled.</li>
      <li><strong>Optional Sharing</strong> ‚Äì Enable Public Mode to upload selected entries to a public archive.</li>
      <li><strong>Offline-Friendly</strong> ‚Äì Works without internet once loaded.</li>
      <li><strong>5MB Limit</strong> ‚Äì Uses browser local storage (~5MB available).</li>
      <li><strong>No Automatic Backup</strong> ‚Äì Clearing browser data will erase your entries unless shared.</li>
    </ul>
  </div>
</div>
  
    <p>&copy; 2025 My Freeform. All rights reserved.</p>
  </footer>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBD-8hcoAuTFaAhgSy-WIyQX_iI37uokTw",
    authDomain: "myfreeformarchive-8a786.firebaseapp.com",
    projectId: "myfreeformarchive-8a786",
    storageBucket: "myfreeformarchive-8a786.appspot.com",
    messagingSenderId: "16237442482",
    appId: "1:16237442482:web:424f8f2e344a58e7f6a0ab"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("fullWritingList");
      let allWritings = JSON.parse(localStorage.getItem("writings")) || [];

      const renderWritingHistory = () => {
        container.innerHTML = "";

        if (allWritings.length === 0) {
          container.innerHTML = "<p>No writings saved yet.</p>";
          return;
        }

        allWritings.slice().reverse().forEach((writing, indexFromEnd) => {
          const index = allWritings.length - 1 - indexFromEnd;

          const box = document.createElement("div");
          box.className = "entry-box";

          const title = document.createElement("h3");
          title.textContent = writing.title;

          const date = document.createElement("p");
          date.innerHTML = `<em>Date: ${writing.date}</em>`;
          
          const content = document.createElement("p");
          content.className = "entry-text";
          content.textContent = writing.content;

          const delBtn = document.createElement("button");
          delBtn.className = "delete-entry-btn";
          delBtn.textContent = "Delete";
          delBtn.onclick = async () => {
  if (!confirm("Are you sure you want to delete this writing?")) return;

  const publicMode = localStorage.getItem("publicModeEnabled") === "true";

  // üî• Delete from Firestore if public mode is on and firebaseId exists
  if (publicMode && writing.firebaseId && typeof db !== "undefined") {
    try {
      await db.collection("publicWritings").doc(writing.firebaseId).delete();
      console.log("üî• Deleted from Firestore:", writing.firebaseId);
    } catch (err) {
      console.error("‚ùå Firebase delete failed:", err);
    }
  }

  // üíæ Always delete locally
  allWritings.splice(index, 1);
  localStorage.setItem("writings", JSON.stringify(allWritings));
  renderWritingHistory();
  updateStorageInfo();
};

          box.appendChild(title);
          box.appendChild(date);
          box.appendChild(content);
          box.appendChild(delBtn);

          container.appendChild(box);
        });
      };

      // ========================
      // üíæ STORAGE USAGE DISPLAY
      // ========================
      function getStorageSize(key) {
        const item = localStorage.getItem(key);
        return item ? new Blob([item]).size : 0;
      }

      function updateStorageInfo() {
        const beliefsSize = getStorageSize("beliefs");
        const progressSize = getStorageSize("inProgress");
        const ideasSize = getStorageSize("ideas");
        const writingsSize = getStorageSize("writings");
        const totalUsed = beliefsSize + progressSize + ideasSize + writingsSize;

        const maxStorage = 5 * 1024 * 1024;
        const usedKB = (totalUsed / 1024).toFixed(1);
        const freeKB = ((maxStorage - totalUsed) / 1024).toFixed(1);
        const percentUsed = ((totalUsed / maxStorage) * 100).toFixed(2);

        const infoEl = document.getElementById("storageInfo");
        if (infoEl) {
          infoEl.innerHTML = `
            <strong>Storage Used:</strong> ${usedKB} KB 
            &nbsp;|&nbsp; 
            <strong>Free:</strong> ${freeKB} KB 
            &nbsp;|&nbsp; 
            <strong>${percentUsed}% of 5MB</strong>
          `;
        }
      }

      renderWritingHistory();
      updateStorageInfo();
    });
  </script>
</body>
</html>

