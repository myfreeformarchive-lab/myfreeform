<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>In-Progress Thoughts History</title>
  <link rel="icon" href="../icon.png" sizes="512x512">
  <link rel="apple-touch-icon" href="../icon.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <header>
    <h1>In-Progress Thoughts History</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="ideas.html">Ideas</a>
      <a href="writings.html">Writings</a>
    </nav>
  </header>

  <main>
    <section class="content-blocks">
      <div class="block">
        <h3>All In-Progress Thoughts</h3>
        <div id="fullProgressList"></div>
      </div>
    </section>
  </main>
  
  <section class="storage-meter">
  <p id="storageInfo">Calculating storage...</p>
</section>

  <footer>
  
  <div class="disclaimer-popover">
  <span class="disclaimer-label">Disclaimer</span>
  <div class="disclaimer-box">
    <p><strong>Local Storage Only:</strong> All your writings are saved in your browser. Nothing is uploaded or shared.</p>
    <ul>
      <li><strong>Private</strong> ‚Äì Your entries never leave your device.</li>
      <li><strong>Offline-friendly</strong> ‚Äì Works without internet once loaded.</li>
      <li><strong>5MB Limit</strong> ‚Äì Uses local storage (~5MB available).</li>
      <li><strong>No Backup</strong> ‚Äì Clearing browser data erases all entries.</li>
    </ul>
  </div>
</div>
  
    <p>&copy; 2025 My Freeform. All rights reserved.</p>
  </footer>
  
<!-- Firebase SDKs (keep these at the top of your scripts) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Ensure firebase is defined
  if (typeof firebase === "undefined") {
    console.error("‚ùå Firebase not loaded properly.");
    return;
  }

  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBD-8hcoAuTFaAhgSy-WIyQX_iI37uokTw",
    authDomain: "myfreeformarchive-8a786.firebaseapp.com",
    projectId: "myfreeformarchive-8a786",
    storageBucket: "myfreeformarchive-8a786.firebasestorage.app",
    messagingSenderId: "16237442482",
    appId: "1:16237442482:web:424f8f2e344a58e7f6a0ab"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const container = document.getElementById("fullProgressList");
  let allProgress = JSON.parse(localStorage.getItem("inProgress")) || [];

  const renderProgressHistory = () => {
    container.innerHTML = "";

    if (allProgress.length === 0) {
      container.innerHTML = "<p>No thoughts saved yet.</p>";
      return;
    }

    allProgress.slice().reverse().forEach((item, indexFromEnd) => {
      const index = allProgress.length - 1 - indexFromEnd;
      const text = typeof item === "string" ? item : item.text;

      const box = document.createElement("div");
      box.className = "entry-box";

      const p = document.createElement("p");
      p.className = "entry-text";
      p.textContent = text;

      const delBtn = document.createElement("button");
      delBtn.className = "delete-entry-btn";
      delBtn.textContent = "Delete";

      delBtn.onclick = async () => {
        if (!confirm("Are you sure you want to delete this idea?")) return;

        const publicMode = localStorage.getItem("publicModeEnabled") === "true";

        if (publicMode && item.firebaseId) {
          try {
            await db.collection("publicInProgress").doc(item.firebaseId).delete();
            console.log("üî• Deleted from Firestore:", item.firebaseId);
          } catch (err) {
            console.error("‚ùå Firebase delete failed:", err);
          }
        }

        allProgress.splice(index, 1);
        localStorage.setItem("inProgress", JSON.stringify(allProgress));
        renderProgressHistory();
        updateStorageInfo();
      };

      box.appendChild(p);
      box.appendChild(delBtn);
      container.appendChild(box);
    });
  };

  function getStorageSize(key) {
    const item = localStorage.getItem(key);
    return item ? new Blob([item]).size : 0;
  }

  function updateStorageInfo() {
    const beliefsSize = getStorageSize("beliefs");
    const progressSize = getStorageSize("inProgress");
    const totalUsed = beliefsSize + progressSize;

    const maxStorage = 5 * 1024 * 1024;
    const usedKB = (totalUsed / 1024).toFixed(1);
    const freeKB = ((maxStorage - totalUsed) / 1024).toFixed(1);
    const percentUsed = ((totalUsed / maxStorage) * 100).toFixed(2);

    const infoEl = document.getElementById("storageInfo");
    if (infoEl) {
      infoEl.innerHTML = `
        <strong>Storage Used:</strong> ${usedKB} KB 
        &nbsp;|&nbsp; 
        <strong>Free:</strong> ${freeKB} KB 
        &nbsp;|&nbsp; 
        <strong>${percentUsed}% of 5MB</strong>
      `;
    }
  }

  renderProgressHistory();
  updateStorageInfo();
});
</script>


</body>
</html>
