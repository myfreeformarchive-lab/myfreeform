import{initializeApp}from"https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";import{getFirestore,collection,addDoc,deleteDoc,doc,updateDoc,query,orderBy,limit,serverTimestamp,onSnapshot,writeBatch,getDocs,increment,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyBD-8hcoAuTFaAhgSy-WIyQX_iI37uokTw",authDomain:"myfreeformarchive-8a786.firebaseapp.com",projectId:"myfreeformarchive-8a786",storageBucket:"myfreeformarchive-8a786.appspot.com",messagingSenderId:"16237442482",appId:"1:16237442482:web:424f8f2e344a58e7f6a0ab"},app=initializeApp(firebaseConfig),db=getFirestore(app),DOM={input:document.getElementById("postInput"),btn:document.getElementById("postBtn"),list:document.getElementById("feedList"),toggle:document.getElementById("publicToggle"),label:document.getElementById("publicLabel"),tabPrivate:document.getElementById("tabPrivate"),tabPublic:document.getElementById("tabPublic"),storage:document.getElementById("storageInfo"),loadTrigger:document.getElementById("loadTrigger"),fontBtns:document.querySelectorAll(".font-btn"),modal:document.getElementById("commentModal"),modalOverlay:document.getElementById("closeModalOverlay"),closeBtn:document.getElementById("closeModalBtn"),modalContent:document.getElementById("modalPostContent"),modalDate:document.getElementById("modalPostDate"),commentList:document.getElementById("commentsList"),commentInput:document.getElementById("commentInput"),commentInputBar:document.querySelector("#commentModal .border-t"),sendComment:document.getElementById("sendCommentBtn"),emojiButtons:document.querySelectorAll(".emoji-btn")};let currentTab=localStorage.getItem("freeform_tab_pref")||"private";const MY_USER_ID=getOrCreateUserId(),BATCH_SIZE=15;let currentLimit=BATCH_SIZE,isLoadingMore=!1,allPrivatePosts=[],selectedFont=localStorage.getItem("freeform_font_pref")||"font-sans",publicUnsubscribe=null,commentsUnsubscribe=null,activePostId=null;function applyFontPreference(e){DOM.input.classList.remove("font-sans","font-serif","font-mono","font-hand"),DOM.input.classList.add(e),DOM.fontBtns.forEach((t=>{t.getAttribute("data-font")===e?t.classList.add("ring-2","ring-brand-500","ring-offset-1"):t.classList.remove("ring-2","ring-brand-500","ring-offset-1")}))}function switchTab(e){currentTab!==e&&(currentTab=e,localStorage.setItem("freeform_tab_pref",e),currentLimit=BATCH_SIZE,updateTabClasses(),loadFeed())}function updateTabClasses(){const e="flex-1 pb-3 text-sm font-bold text-brand-600 border-b-2 border-brand-500 transition-all",t="flex-1 pb-3 text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all";"private"===currentTab?(DOM.tabPrivate.className=e,DOM.tabPublic.className=t):(DOM.tabPublic.className=e,DOM.tabPrivate.className=t)}function updateToggleUI(){const e=DOM.toggle.checked;DOM.label.textContent=e?"Public Mode":"Private Mode",DOM.label.className=e?"text-xs font-bold text-brand-600 transition-colors":"text-xs font-semibold text-slate-500 transition-colors"}function loadFeed(){publicUnsubscribe&&(publicUnsubscribe(),publicUnsubscribe=null),"private"===currentTab?(allPrivatePosts=(JSON.parse(localStorage.getItem("freeform_v2"))||[]).reverse(),renderPrivateBatch()):subscribePublicFeed()}function renderPrivateBatch(){const e=allPrivatePosts.slice(0,currentLimit);DOM.list.innerHTML="",renderListItems(e),DOM.loadTrigger.style.display=currentLimit>=allPrivatePosts.length?"none":"flex"}function subscribePublicFeed(){publicUnsubscribe&&publicUnsubscribe();const e=query(collection(db,"globalPosts"),orderBy("createdAt","desc"),limit(currentLimit));DOM.loadTrigger.style.display="flex",publicUnsubscribe=onSnapshot(e,(e=>{const t=e.docs.map((e=>{const t=e.data(),o=e.id;return updateLocalPostWithServerData(o,t.commentCount||0,t.likeCount||0),{id:o,...t,isFirebase:!0}}));DOM.list.innerHTML="",renderListItems(t),isLoadingMore=!1,DOM.loadTrigger.style.opacity="0"}),(e=>{console.error("Snapshot error:",e),DOM.list.innerHTML='<div class="text-center py-12 text-slate-500">Unable to load feed.</div>'}))}function getSmartShareButtons(e){const t=window.location.href,o=(e?e.length:0)+t.length;return[{id:"copy",limit:999999,name:"Copy Text",icon:'<span class="text-[14px] font-bold leading-none">üìã</span>',classes:"bg-slate-50 text-slate-600 hover:bg-slate-800 hover:border-slate-800 hover:text-white"},{id:"x",limit:280,name:"X",icon:'<span class="text-[13px] font-bold leading-none">ùïè</span>',classes:"bg-slate-50 text-slate-800 hover:bg-black hover:border-black hover:text-white"},{id:"threads",limit:500,name:"Threads",icon:'<span class="text-[15px] font-sans font-bold leading-none mt-[1px]">@</span>',classes:"bg-slate-50 text-slate-800 hover:bg-black hover:border-black hover:text-white"},{id:"whatsapp",limit:2e3,name:"WhatsApp",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592z"/></svg>',classes:"bg-green-50 text-green-600 border-green-200 hover:bg-green-500 hover:border-green-500 hover:text-white"},{id:"messenger",limit:1e3,name:"Messenger",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 7.76C0 3.301 3.493 0 8 0s8 3.301 8 7.76-3.493 7.76-8 7.76c-1.087 0-2.119-.199-3.072-.559L1.4 16l.84-3.525C1.173 11.53 0 9.735 0 7.76zm5.546-1.459-2.35 3.728c-.225.358.214.761.551.506l2.525-1.916a.48.48 0 0 1 .577-.002l2.152 1.628c.456.345 1.086.136 1.258-.419l1.614-3.695c.224-.356-.214-.76-.549-.506l-2.53 1.918a.48.48 0 0 1-.58.002L6.046 5.86c-.456-.345-1.087-.137-1.256.419z"/></svg>',classes:"bg-blue-50 text-blue-500 border-blue-200 hover:bg-blue-500 hover:border-blue-500 hover:text-white"},{id:"telegram",limit:4e3,name:"Telegram",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.287.427-.001.826-.115 1.118-.348 1.325-1.054 2.189-1.728 2.593-2.022.287-.21.57-.18.463.15-.173.53-1.026 1.341-1.581 1.913-.393.407-.735.632-1.066.868-.344.246-.688.492-1.428 1.234.338.567.925.753 1.956 1.433.844.555 1.517.994 2.146 1.063.535.059.972-.218 1.109-.854.275-1.272.846-4.653 1.056-6.176.064-.46-.038-.853-.292-1.127-.376-.402-1.023-.427-1.397-.333z"/></svg>',classes:"bg-sky-50 text-sky-500 border-sky-200 hover:bg-sky-500 hover:border-sky-500 hover:text-white"},{id:"facebook",limit:6e4,name:"Facebook",icon:'<span class="text-[14px] font-bold leading-none font-serif">f</span>',classes:"bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-700 hover:border-blue-700 hover:text-white"}].filter((e=>o<=e.limit))}async function sharePost(e,t){const o=window.location.href,n=encodeURIComponent(e),a=encodeURIComponent(o);if("copy"===t){try{await navigator.clipboard.writeText(`${e}\n\n${o}`),showToast("üìã Copied to clipboard")}catch(e){console.error("Failed to copy",e),showToast("Manual copy required","error")}return}let s="";switch(t){case"x":s=`https://twitter.com/intent/tweet?text=${n}&url=${a}`;break;case"threads":s=`https://www.threads.net/intent/post?text=${n}%20${a}`;break;case"whatsapp":s=`https://wa.me/?text=${n}%20${a}`;break;case"telegram":s=`https://t.me/share/url?url=${a}&text=${n}`;break;case"messenger":s=`http://www.facebook.com/dialog/send?link=${a}&app_id=${firebaseConfig.appId}&redirect_uri=${a}`;break;case"facebook":s=`https://www.facebook.com/sharer/sharer.php?u=${a}&quote=${n}`}s&&window.open(s,"_blank","width=600,height=500,noopener,noreferrer")}function renderListItems(e){0!==e.length?e.forEach((e=>{const t=document.createElement("div");t.className="feed-item bg-white p-5 rounded-xl shadow-sm border border-slate-100 mb-4 hover:shadow-md transition-shadow cursor-pointer relative";const o=getRelativeTime(e.createdAt),n=e.font||"font-sans",a=e.isFirebase&&e.authorId===MY_USER_ID,s=e.isFirebase||e.firebaseId,r=e.isFirebase?e.id:e.firebaseId,l=e.commentCount||0,i=e.likeCount||0,c=!!(JSON.parse(localStorage.getItem("my_likes_cache"))||{})[r],d=s?`\n      <div class="flex items-center gap-5">\n        \n        <div class="like-trigger group flex items-center gap-1.5 cursor-pointer transition-colors"\n             onclick="toggleLike(event, '${r}')">\n          <div class="hover:scale-110 transition-transform duration-200">\n             <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart ${c?"fill-red-500 text-red-500":"fill-none text-slate-400 group-hover:text-red-500"}" width="22" height="22" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">\n               <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>\n               <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572"></path>\n             </svg>\n          </div>\n          <span class="text-sm font-semibold ${c?"text-red-600":"text-slate-500"} count-like-${r}">${i}</span>\n        </div>\n\n        <div class="group flex items-center gap-1.5 relative cursor-pointer text-brand-500 hover:text-brand-700 transition-colors">\n          <div class="hover:scale-110 transition-transform duration-200">\n            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-message-circle-2" width="22" height="22" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">\n               <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>\n               <path d="M3 20l1.3 -3.9a9 8 0 1 1 3.4 2.9l-4.7 1"></path>\n            </svg>\n          </div>\n          <span class="text-sm font-semibold">${l}</span>\n        </div>\n\n      </div>\n    `:'<span class="text-xs text-slate-400 font-medium italic">Private Draft</span>',m=getSmartShareButtons(e.content);let u="";m.forEach((e=>{u+=`\n        <button class="share-icon-btn ${e.classes}" \n          data-platform="${e.id}" \n          title="Share on ${e.name}">\n          ${e.icon}\n        </button>\n      `}));const g=`\n      <div class="mt-3 pt-3 border-t border-slate-50 flex items-center justify-between">\n        ${d}\n        ${`\n      <div class="share-container relative z-20">\n        <div class="share-menu" id="menu-${e.id}">\n          ${u}\n        </div>\n        <button class="share-trigger-btn" onclick="toggleShare(event, 'menu-${e.id}')" title="Share Options">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">\n            <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>\n          </svg>\n        </button>\n      </div>\n    `}\n      </div>\n    `;if(t.innerHTML=`\n      <div class="flex justify-between items-start mb-2">\n        <div class="flex items-center gap-2">\n          <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${e.isFirebase?"bg-blue-50 text-blue-600":"bg-slate-100 text-slate-500"}">\n            ${e.isFirebase?"Global":"Local"}\n          </span>\n          <span class="text-xs text-slate-500 font-medium">${o}</span>\n        </div>\n      </div>\n      <p class="text-slate-800 whitespace-pre-wrap leading-relaxed text-[17px] pointer-events-none ${n}">${cleanText(e.content)}</p>\n      ${g}\n    `,!e.isFirebase||a){const o=document.createElement("button");o.className="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors z-10 p-2",o.innerHTML="‚úï",o.onclick=t=>{t.stopPropagation(),e.isFirebase?deleteGlobal(e.id):deleteLocal(e.id)},t.appendChild(o)}t.onclick=t=>{t.target.closest("button")||t.target.closest(".share-container")||t.target.closest(".like-trigger")||openModal(e)};t.querySelectorAll(".share-icon-btn").forEach((o=>{o.onclick=n=>{n.stopPropagation();const a=o.getAttribute("data-platform");sharePost(e.content,a);const s=t.querySelector(".share-menu"),r=t.querySelector(".share-trigger-btn");s&&s.classList.remove("active"),r&&r.classList.remove("active")}})),DOM.list.appendChild(t)})):DOM.list.innerHTML='<div class="text-center py-12 border-2 border-dashed border-slate-100 rounded-xl"><p class="text-slate-500">No thoughts here yet.</p></div>'}function setupInfiniteScroll(){new IntersectionObserver((e=>{e[0].isIntersecting&&!isLoadingMore&&loadMoreData()}),{root:null,threshold:.1}).observe(DOM.loadTrigger)}function loadMoreData(){isLoadingMore=!0,DOM.loadTrigger.style.opacity="1",setTimeout((()=>{currentLimit+=BATCH_SIZE,"private"===currentTab?(renderPrivateBatch(),isLoadingMore=!1,DOM.loadTrigger.style.opacity="0"):subscribePublicFeed()}),500)}async function handlePost(){const e=DOM.input.value.trim();if(!e)return;const t=DOM.toggle.checked;if(!t||checkSpamGuard(e)){DOM.btn.textContent="...",DOM.btn.disabled=!0;try{let o=null;if(t){o=(await addDoc(collection(db,"globalPosts"),{content:e,font:selectedFont,authorId:MY_USER_ID,createdAt:serverTimestamp(),commentCount:0})).id}const n={id:Date.now().toString(),content:e,font:selectedFont,createdAt:(new Date).toISOString(),isFirebase:!1,firebaseId:o,commentCount:0},a=JSON.parse(localStorage.getItem("freeform_v2"))||[];a.push(n),localStorage.setItem("freeform_v2",JSON.stringify(a)),updateMeter(),t?"private"===currentTab&&switchTab("public"):"public"===currentTab?switchTab("private"):(allPrivatePosts=a.reverse(),renderPrivateBatch()),DOM.input.value="",setRandomPlaceholder()}catch(e){alert("Error: "+e.message)}finally{DOM.btn.textContent="Post",DOM.btn.disabled=!1}}}async function publishDraft(e){showDialog("Publish to World?","This note will be visible to everyone on the Global Feed.","Publish",(async()=>{try{const t=await addDoc(collection(db,"globalPosts"),{content:e.content,font:e.font||"font-sans",authorId:MY_USER_ID,createdAt:serverTimestamp(),commentCount:0,likeCount:0}),o=JSON.parse(localStorage.getItem("freeform_v2"))||[],n=o.findIndex((t=>t.id===e.id));if(-1!==n){o[n].firebaseId=t.id,o[n].commentCount=0,o[n].likeCount=0,localStorage.setItem("freeform_v2",JSON.stringify(o)),allPrivatePosts=o.reverse(),loadFeed();openModal(o.find((t=>t.id===e.id))),showToast("Post is now live!")}}catch(e){console.error("Error publishing draft:",e),showToast("Could not publish. Check connection.","error")}}))}async function deleteLocal(e){showDialog("Delete from Archive?","This will permanently remove this note from your device.","Delete",(async()=>{let t=JSON.parse(localStorage.getItem("freeform_v2"))||[];const o=t.find((t=>t.id===e));if(o&&o.firebaseId)try{const e=writeBatch(db),t=doc(db,"globalPosts",o.firebaseId),n=collection(db,"globalPosts",o.firebaseId,"comments"),a=collection(db,"globalPosts",o.firebaseId,"likes");(await getDocs(n)).forEach((t=>e.delete(t.ref)));(await getDocs(a)).forEach((t=>e.delete(t.ref))),e.delete(t),await e.commit()}catch(e){console.warn("Global version already gone or unreachable:",e)}t=t.filter((t=>t.id!==e)),localStorage.setItem("freeform_v2",JSON.stringify(t)),allPrivatePosts=t.reverse(),renderPrivateBatch(),updateMeter(),showToast("Note deleted from archive","neutral")}))}async function deleteGlobal(e){showDialog("Delete from Global?","This will permanently remove the post for everyone. Comments and likes will also be deleted.","Delete",(async()=>{try{const t=writeBatch(db),o=doc(db,"globalPosts",e),n=collection(db,"globalPosts",e,"comments"),a=collection(db,"globalPosts",e,"likes");(await getDocs(n)).forEach((e=>{t.delete(e.ref)}));(await getDocs(a)).forEach((e=>{t.delete(e.ref)})),t.delete(o),await t.commit(),console.log(`Successfully deleted post ${e}, comments, and likes.`);let s=JSON.parse(localStorage.getItem("freeform_v2"))||[],r=!1;s=s.map((t=>(t.firebaseId===e&&(delete t.firebaseId,t.commentCount=0,t.likeCount=0,r=!0),t))),r&&(localStorage.setItem("freeform_v2",JSON.stringify(s)),allPrivatePosts=s.reverse(),"private"===currentTab&&renderPrivateBatch()),showToast("Post deleted from global feed")}catch(e){console.error("Error during batch delete:",e),showToast("Delete failed. Check connection.","error")}}))}async function toggleLike(e,t){if(e.stopPropagation(),!t||"undefined"===t)return;const o=JSON.parse(localStorage.getItem("my_likes_cache"))||{},n=!!o[t],a=e.currentTarget,s=a.querySelector("svg"),r=a.querySelector("span");let l=parseInt(r.textContent)||0;n?(s.classList.remove("fill-red-500","text-red-500"),s.classList.add("fill-none","text-slate-400"),r.textContent=Math.max(0,l-1),r.classList.remove("text-red-600"),r.classList.add("text-slate-500"),delete o[t]):(s.classList.remove("fill-none","text-slate-400"),s.classList.add("fill-red-500","text-red-500"),r.textContent=l+1,r.classList.remove("text-slate-500"),r.classList.add("text-red-600"),o[t]=!0),localStorage.setItem("my_likes_cache",JSON.stringify(o));try{const e=doc(db,"globalPosts",t),o=doc(db,"globalPosts",t,"likes",MY_USER_ID);n?(await deleteDoc(o),await updateDoc(e,{likeCount:increment(-1)})):(await setDoc(o,{createdAt:serverTimestamp()}),await updateDoc(e,{likeCount:increment(1)}))}catch(e){console.error("Like failed:",e),alert("Connection failed. Like not saved.")}}async function deleteComment(e,t){if(confirm("Delete this comment?"))try{const o=doc(db,"globalPosts",e,"comments",t);await deleteDoc(o);const n=doc(db,"globalPosts",e);await updateDoc(n,{commentCount:increment(-1)}),console.log("Comment deleted successfully")}catch(e){console.error("Error deleting comment:",e),alert("Could not delete comment. You might not have permission.")}}function openModal(e){DOM.input&&(DOM.input.disabled=!0);const t=e.isFirebase?e.id:e.firebaseId;activePostId=t,DOM.modalContent.textContent=e.content;const o=e.font||"font-sans";if(DOM.modalContent.classList.remove("font-sans","font-serif","font-mono","font-hand"),DOM.modalContent.classList.add(o),DOM.modalDate.textContent=getRelativeTime(e.createdAt),DOM.modal.classList.remove("hidden"),document.body.style.overflow="hidden",t){DOM.commentInputBar&&(DOM.commentInputBar.style.display="block");const e=doc(db,"globalPosts",t);onSnapshot(e,(e=>{if(e.exists()){const o=e.data();updateLocalPostWithServerData(t,o.commentCount||0,o.likeCount||0)}}));const o=query(collection(db,`globalPosts/${t}/comments`),orderBy("createdAt","desc"));DOM.commentList.innerHTML='<div class="text-center py-10 text-slate-300 text-sm">Loading...</div>',commentsUnsubscribe=onSnapshot(o,(e=>{DOM.commentList.innerHTML="",e.empty?DOM.commentList.innerHTML='\n          <div class="flex flex-col items-center justify-center py-10 text-center">\n            <div class="text-3xl mb-2 opacity-30">üí≠</div>\n            <div class="text-slate-400 text-sm">No comments yet.<br>Be the first.</div>\n          </div>':e.forEach((e=>{const o=e.data(),n=document.createElement("div"),a=getRelativeTime(o.createdAt),s=o.authorId===MY_USER_ID;n.className="comment-bubble flex flex-col items-start w-full relative group";let r="";if(s&&(r=`<button class="delete-comment-btn ml-2 text-xs font-semibold text-red-300 hover:text-red-500 transition-colors cursor-pointer" data-id="${e.id}">Delete</button>`),n.innerHTML=`\n          <div class="bg-gray-100 px-4 py-2.5 rounded-2xl rounded-tl-none max-w-[90%]">\n             <p class="text-sm text-gray-800 leading-snug break-words font-sans">${cleanText(o.text)}</p>\n          </div>\n          <div class="flex items-center mt-1 ml-1">\n            <span class="text-[10px] text-gray-400">${a}</span>\n            ${r}\n          </div>\n        `,s){const o=n.querySelector(".delete-comment-btn");o&&(o.onclick=()=>deleteComment(t,e.id))}DOM.commentList.appendChild(n)}))}))}else{DOM.commentList.innerHTML='\n      <div class="flex flex-col items-center justify-center py-12 text-center opacity-50">\n        <div class="text-3xl mb-2">üîí</div>\n        <p class="text-sm font-medium">Private Draft</p>\n        <p class="text-xs mt-1">\n          <span id="triggerPublish" class="text-brand-600 font-bold underline cursor-pointer hover:text-brand-700">Share this post</span>\n          to enable comments.\n        </p>\n      </div>';const t=document.getElementById("triggerPublish");t&&(t.onclick=()=>publishDraft(e)),DOM.commentInputBar&&(DOM.commentInputBar.style.display="none")}}function closeModal(){DOM.modal.classList.add("hidden"),document.body.style.overflow="",activePostId=null,commentsUnsubscribe&&(commentsUnsubscribe(),commentsUnsubscribe=null),DOM.input&&(DOM.input.disabled=!1)}async function postComment(){const e=DOM.commentInput.value.trim();if(checkSpamGuard(null)&&e&&activePostId){DOM.sendComment.disabled=!0,DOM.sendComment.style.opacity="0.5";try{await addDoc(collection(db,`globalPosts/${activePostId}/comments`),{text:e,authorId:MY_USER_ID,createdAt:serverTimestamp()});const t=doc(db,"globalPosts",activePostId);await updateDoc(t,{commentCount:increment(1)}),DOM.commentInput.value="";document.getElementById("modalScrollArea").scrollTop=0}catch(e){console.error(e)}finally{DOM.sendComment.disabled=!1,DOM.sendComment.style.opacity="1",DOM.commentInput.focus()}}}function showDialog(e,t,o,n){const a=document.getElementById("custom-dialog"),s=document.getElementById("dialog-title"),r=document.getElementById("dialog-msg"),l=document.getElementById("dialog-confirm-btn");s.textContent=e,r.textContent=t,l.textContent=o||"Confirm";const i=o&&o.toLowerCase().includes("delete");l.className="w-full py-3.5 font-bold border-t border-slate-100 hover:bg-slate-50 transition-colors outline-none",i?l.classList.add("text-red-500"):"Okay"===o||"Understood"===o?l.classList.add("text-slate-700"):l.classList.add("text-brand-600"),a.classList.remove("hidden"),setTimeout((()=>a.classList.add("dialog-open")),10);const c=l.cloneNode(!0);l.parentNode.replaceChild(c,l),c.onclick=()=>{n(),closeDialog()}}function closeDialog(){const e=document.getElementById("custom-dialog");e.classList.remove("dialog-open"),setTimeout((()=>e.classList.add("hidden")),200)}function checkSpamGuard(e){let t=JSON.parse(localStorage.getItem("spam_guard"))||{lastContent:"",repeatCount:0,jailReleaseTime:0};const o=Date.now();if(o<t.jailReleaseTime){return showDialog("Penalty Box ‚ùÑÔ∏è",`You are currently blocked from posting. Please wait ${Math.ceil((t.jailReleaseTime-o)/6e4)} more minutes.`,"Okay",(()=>{})),!1}return null===e||(e===t.lastContent?t.repeatCount++:(t.lastContent=e,t.repeatCount=0),t.repeatCount>=2?(t.jailReleaseTime=o+18e5,localStorage.setItem("spam_guard",JSON.stringify(t)),showDialog("Spam Detected üö®","You posted the exact same thing 3 times. You are taking a 30-minute break.","Understood",(()=>{})),!1):(localStorage.setItem("spam_guard",JSON.stringify(t)),!0))}function updateLocalPostWithServerData(e,t,o){let n=JSON.parse(localStorage.getItem("freeform_v2"))||[],a=!1;n=n.map((n=>(n.firebaseId===e&&(n.commentCount===t&&n.likeCount===o||(n.commentCount=t,n.likeCount=o,a=!0)),n))),a&&(localStorage.setItem("freeform_v2",JSON.stringify(n)),"private"===currentTab&&(allPrivatePosts=n.slice().reverse(),renderPrivateBatch()))}function getOrCreateUserId(){let e=localStorage.getItem("freeform_user_id");return e||(e=Math.random().toString(36).substring(2,6)+"-"+Math.random().toString(36).substring(2,6),localStorage.setItem("freeform_user_id",e)),e}function setRandomPlaceholder(){const e=["What's on your mind?","Share your ideas...","What's the vibe today?","Capture a thought...","Everything starts with a note...","Unfinished thoughts welcome...","Notes for your future self..."];DOM.input.placeholder=e[Math.floor(Math.random()*e.length)]}function updateMeter(){const e=(new Blob([localStorage.getItem("freeform_v2")||""]).size/1024).toFixed(1);DOM.storage.textContent=`${e} KB used`}function cleanText(e){return e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function getRelativeTime(e){if(!e)return"Just now";const t=e.toDate?e.toDate():new Date(e),o=new Date,n=Math.floor((o-t)/1e3);return n<60?"Just now":n<3600?`${Math.floor(n/60)}m`:n<86400?`${Math.floor(n/3600)}h`:n<604800?`${Math.floor(n/86400)}d`:t.toLocaleDateString()}function runMigration(){if(localStorage.getItem("freeform_migrated_v3"))return;let e=JSON.parse(localStorage.getItem("freeform_v2"))||[];["beliefs","inProgress","ideas","writings"].forEach((t=>{const o=JSON.parse(localStorage.getItem(t));Array.isArray(o)&&o.forEach((o=>{const n=o.content||o.text||(o.title?`${o.title}\n${o.content}`:"");n&&e.push({id:Date.now()+Math.random().toString(),content:`[Archived ${t}]: ${n}`,createdAt:o.date||(new Date).toISOString(),isFirebase:!1})}))})),localStorage.setItem("freeform_v2",JSON.stringify(e)),localStorage.setItem("freeform_migrated_v3","true")}document.addEventListener("DOMContentLoaded",(()=>{runMigration(),setRandomPlaceholder();const e=localStorage.getItem("freeform_toggle_pref");DOM.toggle.checked="true"===e,updateToggleUI(),updateTabClasses(),applyFontPreference(selectedFont),loadFeed(),updateMeter(),setupInfiniteScroll(),DOM.btn.addEventListener("click",handlePost),DOM.toggle.addEventListener("change",(()=>{localStorage.setItem("freeform_toggle_pref",DOM.toggle.checked),updateToggleUI()})),DOM.tabPrivate.addEventListener("click",(()=>switchTab("private"))),DOM.tabPublic.addEventListener("click",(()=>switchTab("public"))),DOM.fontBtns.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-font");selectedFont=t,localStorage.setItem("freeform_font_pref",t),applyFontPreference(t),DOM.input.focus()}))})),DOM.modalOverlay.addEventListener("click",closeModal),DOM.closeBtn.addEventListener("click",closeModal),DOM.sendComment.addEventListener("click",postComment),DOM.commentInput.addEventListener("keypress",(e=>{"Enter"===e.key&&postComment()})),DOM.emojiButtons.forEach((e=>{e.addEventListener("click",(()=>{DOM.commentInput.value+=e.getAttribute("data-char"),DOM.commentInput.focus()}))})),document.addEventListener("click",(e=>{e.target.closest(".share-container")||document.querySelectorAll(".share-menu.active").forEach((e=>{e.classList.remove("active"),e.nextElementSibling&&e.nextElementSibling.classList.remove("active")}))}))})),window.toggleShare=function(e,t){e.stopPropagation();const o=document.getElementById(t),n=e.currentTarget;if(!o)return;const a=o.classList.contains("active");document.querySelectorAll(".share-menu.active").forEach((e=>{e.classList.remove("active"),e.nextElementSibling&&e.nextElementSibling.classList.remove("active")})),a||(o.classList.add("active"),n.classList.add("active"))},window.toggleLike=toggleLike,window.showDialog=showDialog,window.closeDialog=closeDialog;
